```{r knitr_setup, include = FALSE}
frf <- function(...)
    rprojroot::find_root_file(..., criterion = ".editorconfig", path = ".")

knitr::opts_chunk$set(
    cache.path = frf("cache", knitr::opts_knit$get('rmarkdown.pandoc.to'), "/")
)

is_docx_output <- function()
    isTRUE(knitr::opts_knit$get("rmarkdown.pandoc.to") == "docx")
ifelse_is_docx <- function(docx, others) {
    if (is_docx_output())
        docx
    else
        others
}
```

```{r package_bibliography, include = FALSE}
knitr::write_bib(
    c(
        "base",
        "gtsummary"
    ),
    file = frf("bibliography", "rpackages.bib")
)
```

```{r libraries, include = FALSE}
library("english")
library("gtsummary")

options(english.UK = FALSE)
```

```{r helper_functions, include = FALSE}
.tbl <- function(tbl, variable, column = "Overall", ...) {
    if (column == "Overall")
        column <- "stat_0"
    gtsummary::inline_text(
        tbl,
        variable = all_of(variable), column = all_of(column), ...
    )
}

.cli_text <- function(...)cli::cli_format_method(cli::cli_text(...))

.pct <- function(x, prec = ".1", symbol = rep_len(TRUE, length(x))) {
    sprintf(
        paste0("%", prec, "f", ifelse(symbol, " %%", "")),
        x * 100
    )
}

#' return numbers as words
.as.word <- function(x)
    ifelse(x > 12, as.character(x), as.character(as.english(as.numeric(x))))
.as.Word <- function(x).capitalize(.as.word(x))
.capitalize <- function(x) {
    substr(x, 1, 1) <- toupper(substr(x, 1, 1))
    x
}
```

```{r import, include = FALSE}
agc <- read.csv(frf("data", "agc.csv"))
periods <- read.csv(frf("data", "periods.csv"))
```

```{r prepare, include = FALSE}
sevodensity <- 1.52 # @Hu2021

agc$WeightGain <- agc$FinalWeight - agc$InitialWeight
agc$TotalUsedVolumeSev <- agc$TotalUsedWeightSev / sevodensity
agc$UsedVolumePerHourSev <- agc$TotalUsedVolumeSev / (agc$TotalDurationCasesSev / 60)
agc$UsedWeightPerHourSev <- agc$TotalUsedWeightSev / (agc$TotalDurationCasesSev / 60)
agc$InVivoMassTransfer <- agc$WeightGain / agc$TotalUsedWeightSev * 100

agc$AvgDurationSev <- agc$TotalDurationCasesSev / agc$TotalCasesSev

periods[c("Start", "End")] <- lapply(periods[c("Start", "End")], as.POSIXct)
```
