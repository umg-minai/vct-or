```{r knitr_setup, include = FALSE}
frf <- function(...)
    rprojroot::find_root_file(..., criterion = ".editorconfig", path = ".")

knitr::opts_chunk$set(
    cache.path = frf("cache", knitr::opts_knit$get('rmarkdown.pandoc.to'), "/")
)

is_docx_output <- function()
    isTRUE(knitr::opts_knit$get("rmarkdown.pandoc.to") == "docx")
ifelse_is_docx <- function(docx, others) {
    if (is_docx_output())
        docx
    else
        others
}
```

```{r package_bibliography, include = FALSE}
knitr::write_bib(
    c(
        "base",
        "gtsummary"
    ),
    file = frf("bibliography", "rpackages.bib")
)
```

```{r libraries, include = FALSE}
library("english")
library("gtsummary")
library("lubridate")

options(english.UK = FALSE)
```

```{r helper_functions, include = FALSE}
.tbl <- function(tbl, variable, column = "Overall", ...) {
    if (column == "Overall")
        column <- "stat_0"
    gtsummary::inline_text(
        tbl,
        variable = all_of(variable), column = all_of(column), ...
    )
}

.cli_text <- function(...)cli::cli_format_method(cli::cli_text(...))

.pct <- function(x, prec = ".1", symbol = rep_len(TRUE, length(x))) {
    sprintf(
        paste0("%", prec, "f", ifelse(symbol, " %%", "")),
        x * 100
    )
}

#' return numbers as words
.as.word <- function(x)
    ifelse(x > 12, as.character(x), as.character(as.english(as.numeric(x))))
.as.Word <- function(x).capitalize(.as.word(x))
.capitalize <- function(x) {
    substr(x, 1, 1) <- toupper(substr(x, 1, 1))
    x
}
```

```{r constants, include = FALSE}
sevodensity <- 1.52 # @Hu2021
ORnames <- paste0("OR", 1:2)
```

```{r import, include = FALSE}
agc <- read.csv(frf("data", "agc.csv"))
cases <- read.csv(frf("data", "cases.csv"))
periods <- read.csv(frf("data", "periods.csv"))
flowvapor <- read.csv(frf("data", "flow-vapor-settings.csv"))
```

```{r prepare, include = FALSE}
agc$OR <- ifelse(agc$OR == 21, ORnames[1], ORnames[2])
agc$WeightGain <- agc$FinalWeight - agc$InitialWeight
agc$TotalUsedVolumeSev <- agc$TotalUsedWeightSev / sevodensity
agc$UsedVolumePerHourSev <- agc$TotalUsedVolumeSev / (agc$TotalDurationCasesSev / 60)
agc$UsedWeightPerHourSev <- agc$TotalUsedWeightSev / (agc$TotalDurationCasesSev / 60)
agc$InVivoMassTransfer <- agc$WeightGain / agc$TotalUsedWeightSev * 100

agc$AvgDurationSev <- agc$TotalDurationCasesSev / agc$TotalCasesSev

cases$Date <- ymd(cases$Date)
cases <- cases[wday(cases$Date) %in% 2:6,]  # keep only working days
cases <- cases[cases$Duration > 5,]         # drop test/calibration
cases$OR <- ifelse(cases$Device == "ASDD-0018", ORnames[1], ORnames[2])

ORcases <- vapply(
    split(cases$Date, cases$OR), \(x)median(tapply(x, x, length)), NA_real_
)

periods[c("Start", "End")] <- lapply(periods[c("Start", "End")], as.POSIXct)
```

```{r fit-weight-loss, include = FALSE}
fit.weigth.loss <- lm(LostWeight ~ 0 + DaysStored, data = agc)
```

```{r sevoflurane-consumption-estimation-agc14, include = FALSE}
#' Calculate volatile agent consumption as described in @Biro2015
#'
#' @param flow double, fresh gas flow in L/min
#' @param vapor double, concentration of volatile anaesthetic in Vol%
#' @param duration double, duration of setting in min
#' @param density double(1), density of the used volatile agent
#' @param satvol double(1), saturated gas volume of the used volatile agent
#' @return volatile agent consumption in g
.consumption <- function(flow, vapor, duration, density = sevodensity,
                         satvol = 184) {
    ( ((flow * 1000) * vapor * duration) / (satvol * 100) )  * density
}

flowvapor$Consumption <- .consumption(
    flowvapor$Flow, flowvapor$Vapor, flowvapor$Duration
)
```
